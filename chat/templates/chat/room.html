{% extends 'base.html' %}

{% block content %}
<div class="chat-container">
    <div id="chat-container" data-room-id="{{ room.id }}">
        <h2 class="mb-3">
            Chat with {{ room.doctor.get_full_name|default:room.doctor.username }}
            <small class="text-muted">(Room #{{ room.id }})</small>
        </h2>
    </div>

    <div class="chat-messages" id="chat-messages">
        {% for message in messages %}
        <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            <div class="message-content">{{ message.message|safe }}</div>
            <div class="message-meta">
                <small class="message-time">{{ message.timestamp|date:"H:i" }}</small>
                {% if message.sender == request.user %}
                <span class="message-status">
                    {% if message.read %}✓✓{% else %}✓{% endif %}
                </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="chat-input">
        <input type="text" id="message-input" placeholder="Type your message..." class="form-control">
        <button id="send-button" class="btn btn-primary">
            <i class="bi bi-send"></i> Send
        </button>
    </div>
</div>

<style>
    .chat-container {
        max-width: 800px;
        margin: 0 auto;
        height: 80vh;
        display: flex;
        flex-direction: column;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 1rem;
        max-width: 70%;
    }

        .message.received {
            background-color: #ffffff;
            margin-right: auto;
            border: 1px solid #dee2e6;
        }

        .message.sent {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }

    .message-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .message-status {
        margin-left: 0.5rem;
    }

    .chat-input {
        display: flex;
        gap: 0.5rem;
        padding: 1rem 0;
    }

    #message-input {
        flex: 1;
        border-radius: 20px;
        padding: 0.75rem 1.25rem;
    }
</style>

<script>
    
    
    
    // Get the chat container and room ID
    const chatContainer = document.getElementById('chat-container');
    const room_id = "{{ room.id|safe }}"; // Access room_id from room object

    // Construct the WebSocket URL
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsPath = wsScheme + "://" + window.location.host + "/ws/chat/" + room_id + "/";

    console.log("WebSocket URL:", wsPath); // Log the WebSocket URL for debugging

    // Create a new WebSocket connection
    const chatSocket = new WebSocket(wsPath);

    // Function to escape HTML to prevent XSS attacks
    function escapeHTML(string) {
        let pre = document.createElement('pre');
        let text = document.createTextNode(string);
        pre.appendChild(text);
        return pre.innerHTML;
    }

    // Handle incoming messages from the WebSocket
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data); // Parse the JSON data
        const messagesDiv = document.getElementById('chat-messages'); // Get the chat messages container

        if (data.type === 'message') {
            const isSent = data.sender === '{{ request.user.username }}'; // Check if the message was sent by the current user
            const escapedMessage = escapeHTML(data.message); // Escape the message content to prevent XSS

            // Create the message HTML
            const messageHTML = `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-content">${escapedMessage}</div>
                    <div class="message-meta">
                        <small class="message-time">
                            ${new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                        </small>
                        ${isSent ? `<span class="message-status">${data.read ? '✓✓' : '✓'}</span>` : ''}
                    </div>
                </div>`;

            messagesDiv.insertAdjacentHTML('beforeend', messageHTML); // Add the message to the chat messages container
            messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to the bottom of the chat messages container
        }
        else if (data.type === 'read_receipt') {
            // Update the read receipt status for all sent messages
            document.querySelectorAll(`.message.sent .message-status`).forEach(span => {
                span.textContent = '✓✓';
            });
        }
    };

    // Message sending function
    function sendMessage() {
        const messageInput = document.querySelector('#message-input'); // Get the message input
        const message = messageInput.value.trim(); // Get the message content and trim whitespace

        if (message) {
            chatSocket.send(JSON.stringify({
                'type': 'message',
                'message': message
            })); // Send the message to the server
            messageInput.value = ''; // Clear the message input
        }
    }

    // Add event listeners to the send button and message input
    document.querySelector('#send-button').addEventListener('click', sendMessage); // Send message on button click
    document.querySelector('#message-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage(); // Send message on Enter key press (without Shift key)
        }
    });

    // Connection handling
    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly'); // Log the error to the console
        showConnectionWarning(); // Display a connection warning to the user
    };

    chatSocket.onerror = function (err) {
        console.error('WebSocket error:', err); // Log the error to the console
        showConnectionWarning(); // Display a connection warning to the user
    };

    // Function to display a connection warning
    function showConnectionWarning() {
        const warning = document.createElement('div'); // Create a new div element
        warning.className = 'alert alert-danger mt-3'; // Add CSS classes to the div
        warning.textContent = 'Connection lost. Please refresh the page.'; // Set the text content of the div
        document.querySelector('.chat-container').appendChild(warning); // Add the warning to the chat container
    }

    // Keep connection alive by sending ping messages
    setInterval(() => {
        if (chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({ 'type': 'ping' })); // Send a ping message
        }
    }, 25000);

    // Scroll to the bottom of the chat messages on page load
    window.addEventListener('DOMContentLoaded', () => {
        const messagesDiv = document.getElementById('chat-messages'); // Get the chat messages container
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to the bottom
    });
</script>
{% endblock %}